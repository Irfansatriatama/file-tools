<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>File Tools ‚Äî Local & Private</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap');
  :root {
    --bg:#0d0d0f;--surface:#17171a;--surface2:#1f1f23;--border:#2a2a30;
    --accent:#e8ff47;--accent2:#47ffe8;--text:#f0f0f5;--muted:#7a7a8a;
    --danger:#ff4747;--radius:12px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(232,255,71,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(232,255,71,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
  .container{max-width:940px;margin:0 auto;padding:40px 20px;position:relative;z-index:1;}
  header{margin-bottom:40px;}
  .logo{font-family:'Syne',sans-serif;font-size:2.2rem;font-weight:800;letter-spacing:-1px;display:flex;align-items:center;gap:12px;}
  .logo span.accent{color:var(--accent);}
  .badge{font-family:'DM Mono',monospace;font-size:0.65rem;background:rgba(232,255,71,0.12);color:var(--accent);border:1px solid rgba(232,255,71,0.3);padding:3px 8px;border-radius:4px;letter-spacing:1px;}
  .subtitle{color:var(--muted);font-size:0.82rem;margin-top:8px;letter-spacing:0.5px;}

  /* Tab groups */
  .tab-group-label{font-size:0.65rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;padding-left:4px;}
  .tabs-wrap{display:flex;flex-direction:column;gap:10px;margin-bottom:32px;}
  .tabs{display:flex;gap:4px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px;flex-wrap:wrap;}
  .tab{flex:1;min-width:120px;padding:9px 14px;border:none;background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:0.75rem;cursor:pointer;border-radius:8px;transition:all 0.2s;letter-spacing:0.4px;white-space:nowrap;text-align:center;}
  .tab:hover{color:var(--text);background:var(--surface2);}
  .tab.active{background:var(--accent);color:#0d0d0f;font-weight:500;}
  .tab.active2{background:var(--accent2);color:#0d0d0f;font-weight:500;}

  .panel{display:none;}.panel.active{display:block;}
  .panel-title{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:700;margin-bottom:6px;}
  .panel-desc{color:var(--muted);font-size:0.78rem;margin-bottom:24px;line-height:1.6;}
  .warning-box{background:rgba(232,255,71,0.06);border:1px solid rgba(232,255,71,0.2);border-radius:8px;padding:12px 16px;font-size:0.75rem;color:rgba(232,255,71,0.8);margin-bottom:24px;line-height:1.6;}

  .dropzone{border:2px dashed var(--border);border-radius:var(--radius);padding:48px 24px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--surface);position:relative;}
  .dropzone:hover,.dropzone.drag-over{border-color:var(--accent);background:rgba(232,255,71,0.04);}
  .dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
  .drop-icon{font-size:2.5rem;margin-bottom:12px;display:block;}
  .drop-text{font-family:'Syne',sans-serif;font-size:1rem;font-weight:600;margin-bottom:4px;}
  .drop-sub{font-size:0.73rem;color:var(--muted);}

  .file-list{margin-top:16px;display:flex;flex-direction:column;gap:8px;}
  .file-item{display:flex;align-items:center;gap:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:0.78rem;}
  .file-item .name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .file-item .size{color:var(--muted);}
  .file-item button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;padding:2px 6px;border-radius:4px;transition:all 0.15s;}
  .file-item button:hover{color:var(--danger);background:rgba(255,71,71,0.1);}

  .btn-row{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;}
  .btn{padding:11px 22px;border:none;border-radius:8px;font-family:'DM Mono',monospace;font-size:0.8rem;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;font-weight:500;}
  .btn-primary{background:var(--accent);color:#0d0d0f;}
  .btn-primary:hover{background:#d4e83e;transform:translateY(-1px);}
  .btn-primary:disabled{opacity:0.4;cursor:not-allowed;transform:none;}
  .btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
  .btn-secondary:hover{border-color:var(--accent);color:var(--accent);}

  .options-group{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-top:16px;}
  .options-group label{font-size:0.78rem;color:var(--muted);display:block;margin-bottom:8px;letter-spacing:0.5px;}
  .radio-group{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;}
  .radio-opt{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.8rem;padding:8px 14px;border:1px solid var(--border);border-radius:6px;transition:all 0.15s;}
  .radio-opt:has(input:checked){border-color:var(--accent);color:var(--accent);background:rgba(232,255,71,0.06);}
  .radio-opt input{accent-color:var(--accent);}
  input[type=text],input[type=number],select{background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.8rem;padding:8px 12px;outline:none;transition:border-color 0.15s;}
  input[type=text]:focus,input[type=number]:focus,select:focus{border-color:var(--accent);}
  select option{background:var(--surface2);}

  .status{margin-top:16px;padding:12px 16px;border-radius:8px;font-size:0.78rem;display:none;line-height:1.5;}
  .status.info{background:rgba(71,255,232,0.08);border:1px solid rgba(71,255,232,0.25);color:var(--accent2);}
  .status.success{background:rgba(232,255,71,0.08);border:1px solid rgba(232,255,71,0.25);color:var(--accent);}
  .status.error{background:rgba(255,71,71,0.08);border:1px solid rgba(255,71,71,0.25);color:var(--danger);}
  .progress-bar{height:3px;background:var(--border);border-radius:2px;margin-top:12px;overflow:hidden;display:none;}
  .progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s;width:0%;}

  /* Merge drag */
  .merge-list{margin-top:12px;}
  .merge-item{display:flex;align-items:center;gap:10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin-bottom:6px;font-size:0.78rem;cursor:grab;transition:border-color 0.15s;user-select:none;}
  .merge-item:active{cursor:grabbing;}
  .merge-item.drag-over-item{border-color:var(--accent);background:rgba(232,255,71,0.06);}
  .merge-item .handle{color:var(--muted);font-size:1rem;}
  .merge-item .idx{color:var(--muted);min-width:20px;text-align:right;font-size:0.7rem;}
  .merge-item .mname{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .merge-item .msize{color:var(--muted);font-size:0.7rem;}
  .merge-item .mdel{background:none;border:none;color:var(--muted);cursor:pointer;padding:2px 6px;border-radius:4px;}
  .merge-item .mdel:hover{color:var(--danger);}
  .move-btns{display:flex;flex-direction:column;gap:2px;}
  .move-btns button{background:none;border:1px solid var(--border);color:var(--muted);cursor:pointer;font-size:0.7rem;padding:1px 5px;border-radius:3px;line-height:1.4;}
  .move-btns button:hover{border-color:var(--accent);color:var(--accent);}

  /* Image preview grid */
  .img-preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:12px;}
  .img-thumb{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;position:relative;aspect-ratio:1;}
  .img-thumb img{width:100%;height:100%;object-fit:cover;}
  .img-thumb .thumb-name{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);font-size:0.65rem;padding:4px 6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .img-thumb .thumb-del{position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);border:none;color:#fff;cursor:pointer;border-radius:50%;width:22px;height:22px;font-size:0.75rem;display:flex;align-items:center;justify-content:center;}
  .img-thumb .thumb-del:hover{background:var(--danger);}

  .inline-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px;}
  .inline-row label{font-size:0.75rem;color:var(--muted);}

  footer{margin-top:60px;padding-top:20px;border-top:1px solid var(--border);text-align:center;font-size:0.7rem;color:var(--muted);letter-spacing:0.5px;}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo"><span>File<span class="accent">Tools</span></span><span class="badge">100% LOCAL</span></div>
    <p class="subtitle">// semua proses terjadi di browser ‚Äî tidak ada file yang dikirim ke server manapun</p>
  </header>

  <div class="tabs-wrap">
    <div>
      <div class="tab-group-label">üìÑ PDF Tools</div>
      <div class="tabs">
        <button class="tab active" onclick="switchTab('merge',this)">‚äï Merge PDF</button>
        <button class="tab" onclick="switchTab('split',this)">‚úÇ Split PDF</button>
        <button class="tab" onclick="switchTab('pdf2docx',this)">PDF ‚Üí DOCX</button>
        <button class="tab" onclick="switchTab('docx2pdf',this)">DOCX ‚Üí PDF</button>
        <button class="tab" onclick="switchTab('pdf2png',this)">PDF ‚Üí PNG</button>
      </div>
    </div>
    <div>
      <div class="tab-group-label">üñº Image Tools</div>
      <div class="tabs">
        <button class="tab" onclick="switchTab('img2pdf',this)">JPG/PNG ‚Üí PDF</button>
        <button class="tab" onclick="switchTab('jpg2png',this)">JPG ‚Üí PNG</button>
      </div>
    </div>
  </div>

  <!-- ===== MERGE ===== -->
  <div id="tab-merge" class="panel active">
    <h2 class="panel-title">Merge PDF</h2>
    <p class="panel-desc">Gabungkan beberapa file PDF menjadi satu. Atur urutan dengan drag-and-drop atau tombol panah.</p>
    <div class="dropzone" id="merge-drop">
      <input type="file" id="merge-input" multiple accept=".pdf">
      <span class="drop-icon">üìÑ</span>
      <div class="drop-text">Klik atau seret file PDF di sini</div>
      <div class="drop-sub">Pilih beberapa file sekaligus</div>
    </div>
    <div class="merge-list" id="merge-list"></div>
    <div class="btn-row">
      <button class="btn btn-primary" id="merge-btn" onclick="mergePDFs()" disabled>Merge & Download</button>
      <button class="btn btn-secondary" onclick="clearMerge()">Bersihkan</button>
    </div>
    <div class="status" id="merge-status"></div>
    <div class="progress-bar" id="merge-progress"><div class="progress-fill" id="merge-fill"></div></div>
  </div>

  <!-- ===== SPLIT ===== -->
  <div id="tab-split" class="panel">
    <h2 class="panel-title">Split PDF</h2>
    <p class="panel-desc">Pisahkan halaman PDF. Bisa per halaman, range, atau halaman spesifik.</p>
    <div class="dropzone" id="split-drop">
      <input type="file" id="split-input" accept=".pdf">
      <span class="drop-icon">‚úÇÔ∏è</span>
      <div class="drop-text">Klik atau seret file PDF</div>
      <div class="drop-sub">Satu file PDF saja</div>
    </div>
    <div class="file-list" id="split-file-list"></div>
    <div class="options-group" id="split-options" style="display:none">
      <label>PILIH MODE SPLIT</label>
      <div class="radio-group">
        <label class="radio-opt"><input type="radio" name="split-mode" value="all" checked onchange="updateSplitUI()"> Semua halaman</label>
        <label class="radio-opt"><input type="radio" name="split-mode" value="range" onchange="updateSplitUI()"> Range halaman</label>
        <label class="radio-opt"><input type="radio" name="split-mode" value="custom" onchange="updateSplitUI()"> Halaman spesifik</label>
      </div>
      <div id="split-range-ui" style="display:none"><label>RANGE (contoh: 1-3, 5-8)</label><input type="text" id="split-ranges" placeholder="1-3, 4-7, 8-10" style="width:100%"></div>
      <div id="split-custom-ui" style="display:none"><label>HALAMAN (contoh: 1,3,5)</label><input type="text" id="split-pages" placeholder="1, 3, 5" style="width:100%"></div>
      <div id="split-all-info" style="margin-top:8px;font-size:0.75rem;color:var(--muted)">Setiap halaman ‚Üí file PDF terpisah, didownload sebagai ZIP.</div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" id="split-btn" onclick="splitPDF()" disabled>Split & Download</button>
      <button class="btn btn-secondary" onclick="clearSplit()">Bersihkan</button>
    </div>
    <div class="status" id="split-status"></div>
    <div class="progress-bar" id="split-progress"><div class="progress-fill" id="split-fill"></div></div>
  </div>

  <!-- ===== PDF to DOCX ===== -->
  <div id="tab-pdf2docx" class="panel">
    <h2 class="panel-title">PDF ‚Üí DOCX</h2>
    <p class="panel-desc">Ekstrak teks dari PDF dan simpan sebagai file Word (.docx).</p>
    <div class="warning-box">‚ö† Konversi bersifat best-effort. Teks & paragraf diekstrak, layout kompleks (tabel, kolom, gambar) mungkin tidak sempurna.</div>
    <div class="dropzone" id="p2d-drop">
      <input type="file" id="p2d-input" accept=".pdf">
      <span class="drop-icon">üìã</span>
      <div class="drop-text">Klik atau seret file PDF</div>
      <div class="drop-sub">Satu file PDF</div>
    </div>
    <div class="file-list" id="p2d-file-list"></div>
    <div class="btn-row">
      <button class="btn btn-primary" id="p2d-btn" onclick="convertPDF2DOCX()" disabled>Konversi & Download</button>
      <button class="btn btn-secondary" onclick="clearP2D()">Bersihkan</button>
    </div>
    <div class="status" id="p2d-status"></div>
    <div class="progress-bar" id="p2d-progress"><div class="progress-fill" id="p2d-fill"></div></div>
  </div>

  <!-- ===== DOCX to PDF ===== -->
  <div id="tab-docx2pdf" class="panel">
    <h2 class="panel-title">DOCX ‚Üí PDF</h2>
    <p class="panel-desc">Konversi file Word (.docx) ke PDF menggunakan rendering HTML + jsPDF.</p>
    <div class="warning-box">‚ö† Mammoth.js mengekstrak konten DOCX ‚Üí HTML ‚Üí PDF. Formatting sederhana dipertahankan, layout kompleks mungkin berbeda.</div>
    <div class="dropzone" id="d2p-drop">
      <input type="file" id="d2p-input" accept=".docx">
      <span class="drop-icon">üìù</span>
      <div class="drop-text">Klik atau seret file DOCX</div>
      <div class="drop-sub">Satu file .docx</div>
    </div>
    <div class="file-list" id="d2p-file-list"></div>
    <div class="btn-row">
      <button class="btn btn-primary" id="d2p-btn" onclick="convertDOCX2PDF()" disabled>Konversi & Download</button>
      <button class="btn btn-secondary" onclick="clearD2P()">Bersihkan</button>
    </div>
    <div class="status" id="d2p-status"></div>
    <div class="progress-bar" id="d2p-progress"><div class="progress-fill" id="d2p-fill"></div></div>
  </div>

  <!-- ===== PDF to PNG ===== -->
  <div id="tab-pdf2png" class="panel">
    <h2 class="panel-title">PDF ‚Üí PNG</h2>
    <p class="panel-desc">Render setiap halaman PDF menjadi gambar PNG. Output berupa ZIP berisi semua halaman.</p>
    <div class="dropzone" id="pdf2png-drop">
      <input type="file" id="pdf2png-input" accept=".pdf">
      <span class="drop-icon">üñº</span>
      <div class="drop-text">Klik atau seret file PDF</div>
      <div class="drop-sub">Satu file PDF</div>
    </div>
    <div class="file-list" id="pdf2png-file-list"></div>
    <div class="options-group" id="pdf2png-options" style="display:none">
      <div class="inline-row">
        <label>KUALITAS (DPI scale):</label>
        <select id="pdf2png-scale">
          <option value="1">72 DPI (cepat)</option>
          <option value="1.5">108 DPI</option>
          <option value="2" selected>144 DPI (standar)</option>
          <option value="3">216 DPI (tinggi)</option>
        </select>
        <label>HALAMAN:</label>
        <select id="pdf2png-pages">
          <option value="all" selected>Semua halaman</option>
          <option value="custom">Halaman tertentu</option>
        </select>
      </div>
      <div id="pdf2png-custom-pages" style="display:none;margin-top:10px">
        <label>NOMOR HALAMAN (contoh: 1,3,5)</label>
        <input type="text" id="pdf2png-page-list" placeholder="1, 2, 3" style="width:100%">
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" id="pdf2png-btn" onclick="convertPDF2PNG()" disabled>Render & Download ZIP</button>
      <button class="btn btn-secondary" onclick="clearPDF2PNG()">Bersihkan</button>
    </div>
    <div class="status" id="pdf2png-status"></div>
    <div class="progress-bar" id="pdf2png-progress"><div class="progress-fill" id="pdf2png-fill"></div></div>
  </div>

  <!-- ===== IMG to PDF ===== -->
  <div id="tab-img2pdf" class="panel">
    <h2 class="panel-title">JPG / PNG ‚Üí PDF</h2>
    <p class="panel-desc">Gabungkan satu atau beberapa gambar (JPG/JPEG/PNG) menjadi satu file PDF. Setiap gambar = satu halaman.</p>
    <div class="dropzone" id="img2pdf-drop">
      <input type="file" id="img2pdf-input" multiple accept=".jpg,.jpeg,.png,image/jpeg,image/png">
      <span class="drop-icon">üñº</span>
      <div class="drop-text">Klik atau seret gambar JPG/PNG</div>
      <div class="drop-sub">Bisa pilih banyak file sekaligus</div>
    </div>
    <div class="img-preview-grid" id="img2pdf-preview"></div>
    <div class="options-group" id="img2pdf-options" style="display:none;margin-top:16px">
      <div class="inline-row">
        <label>UKURAN HALAMAN:</label>
        <select id="img2pdf-pagesize">
          <option value="fit" selected>Sesuaikan gambar</option>
          <option value="a4">A4 Portrait</option>
          <option value="a4l">A4 Landscape</option>
          <option value="letter">Letter</option>
        </select>
        <label>MARGIN (px):</label>
        <input type="number" id="img2pdf-margin" value="0" min="0" max="100" style="width:70px">
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" id="img2pdf-btn" onclick="convertImg2PDF()" disabled>Buat PDF & Download</button>
      <button class="btn btn-secondary" onclick="clearImg2PDF()">Bersihkan</button>
    </div>
    <div class="status" id="img2pdf-status"></div>
    <div class="progress-bar" id="img2pdf-progress"><div class="progress-fill" id="img2pdf-fill"></div></div>
  </div>

  <!-- ===== JPG to PNG ===== -->
  <div id="tab-jpg2png" class="panel">
    <h2 class="panel-title">JPG ‚Üí PNG</h2>
    <p class="panel-desc">Konversi file JPG/JPEG menjadi PNG. Bisa batch (banyak file sekaligus), output ZIP jika lebih dari 1 file.</p>
    <div class="dropzone" id="jpg2png-drop">
      <input type="file" id="jpg2png-input" multiple accept=".jpg,.jpeg,image/jpeg">
      <span class="drop-icon">üîÑ</span>
      <div class="drop-text">Klik atau seret file JPG/JPEG</div>
      <div class="drop-sub">Bisa pilih banyak file</div>
    </div>
    <div class="img-preview-grid" id="jpg2png-preview"></div>
    <div class="btn-row">
      <button class="btn btn-primary" id="jpg2png-btn" onclick="convertJPG2PNG()" disabled>Konversi & Download</button>
      <button class="btn btn-secondary" onclick="clearJPG2PNG()">Bersihkan</button>
    </div>
    <div class="status" id="jpg2png-status"></div>
    <div class="progress-bar" id="jpg2png-progress"><div class="progress-fill" id="jpg2png-fill"></div></div>
  </div>

  <footer>File Tools ‚Äî 100% client-side ¬∑ tidak ada upload server ¬∑ privasi terjaga</footer>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
if(typeof pdfjsLib!=='undefined'){pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';}

// ====== UTILS ======
function switchTab(name,el){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>{t.classList.remove('active');t.classList.remove('active2');});
  document.getElementById('tab-'+name).classList.add('active');
  if(el) el.classList.add('active');
}
function showStatus(id,msg,type){const el=document.getElementById(id);el.textContent=msg;el.className='status '+type;el.style.display='block';}
function setProgress(fillId,barId,pct){const bar=document.getElementById(barId);const fill=document.getElementById(fillId);if(pct===null){bar.style.display='none';return;}bar.style.display='block';fill.style.width=pct+'%';}
function fmtSize(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}
function downloadBlob(blob,filename){const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},1000);}

function setupDrop(dropId,inputId,onFiles){
  const drop=document.getElementById(dropId);if(!drop)return;
  drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('drag-over');});
  drop.addEventListener('dragleave',()=>drop.classList.remove('drag-over'));
  drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('drag-over');onFiles(Array.from(e.dataTransfer.files));});
  document.getElementById(inputId).addEventListener('change',function(){onFiles(Array.from(this.files));this.value='';});
}

function loadImage(file){return new Promise((res,rej)=>{const img=new Image();img.onload=()=>res(img);img.onerror=rej;img.src=URL.createObjectURL(file);});}
function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=rej;r.readAsDataURL(file);});}

// ====== MERGE ======
let mergeFiles=[];
setupDrop('merge-drop','merge-input',files=>{mergeFiles.push(...files.filter(f=>f.name.match(/\.pdf$/i)));renderMergeList();});
function renderMergeList(){
  const list=document.getElementById('merge-list');
  if(!mergeFiles.length){list.innerHTML='';document.getElementById('merge-btn').disabled=true;return;}
  document.getElementById('merge-btn').disabled=mergeFiles.length<2;
  list.innerHTML=mergeFiles.map((f,i)=>`
    <div class="merge-item" draggable="true" data-idx="${i}" ondragstart="mergeDragStart(event,${i})" ondragover="mergeDragOver(event,${i})" ondrop="mergeDrop(event,${i})" ondragleave="mergeDragLeave(event)">
      <span class="handle">‚†ø</span><span class="idx">${i+1}</span>
      <span class="mname">${f.name}</span><span class="msize">${fmtSize(f.size)}</span>
      <div class="move-btns"><button onclick="mergeMove(${i},-1)">‚ñ≤</button><button onclick="mergeMove(${i},1)">‚ñº</button></div>
      <button class="mdel" onclick="mergeRemove(${i})">‚úï</button>
    </div>`).join('');
}
let _mdi=null;
function mergeDragStart(e,i){_mdi=i;e.dataTransfer.effectAllowed='move';}
function mergeDragOver(e,i){e.preventDefault();document.querySelectorAll('.merge-item')[i]?.classList.add('drag-over-item');}
function mergeDragLeave(e){e.currentTarget.classList.remove('drag-over-item');}
function mergeDrop(e,i){e.preventDefault();document.querySelectorAll('.merge-item').forEach(el=>el.classList.remove('drag-over-item'));if(_mdi===null||_mdi===i)return;const it=mergeFiles.splice(_mdi,1)[0];mergeFiles.splice(i,0,it);_mdi=null;renderMergeList();}
function mergeMove(i,d){const ni=i+d;if(ni<0||ni>=mergeFiles.length)return;[mergeFiles[i],mergeFiles[ni]]=[mergeFiles[ni],mergeFiles[i]];renderMergeList();}
function mergeRemove(i){mergeFiles.splice(i,1);renderMergeList();}
function clearMerge(){mergeFiles=[];renderMergeList();document.getElementById('merge-status').style.display='none';setProgress('merge-fill','merge-progress',null);}
async function mergePDFs(){
  if(mergeFiles.length<2)return;
  const btn=document.getElementById('merge-btn');btn.disabled=true;
  showStatus('merge-status','Memproses...','info');setProgress('merge-fill','merge-progress',5);
  try{
    const{PDFDocument}=PDFLib;const merged=await PDFDocument.create();
    for(let i=0;i<mergeFiles.length;i++){
      setProgress('merge-fill','merge-progress',10+Math.round((i/mergeFiles.length)*80));
      const ab=await mergeFiles[i].arrayBuffer();const doc=await PDFDocument.load(ab);
      const pages=await merged.copyPages(doc,doc.getPageIndices());pages.forEach(p=>merged.addPage(p));
    }
    setProgress('merge-fill','merge-progress',95);
    const bytes=await merged.save();
    downloadBlob(new Blob([bytes],{type:'application/pdf'}),'merged.pdf');
    setProgress('merge-fill','merge-progress',100);
    showStatus('merge-status',`‚úì Berhasil! ${mergeFiles.length} file digabung ‚Üí merged.pdf`,'success');
  }catch(e){showStatus('merge-status','‚úó Error: '+e.message,'error');setProgress('merge-fill','merge-progress',null);}
  btn.disabled=false;
}

// ====== SPLIT ======
let splitFile=null;
setupDrop('split-drop','split-input',files=>{const f=files.find(f=>f.name.match(/\.pdf$/i));if(f)setSplitFile(f);});
function setSplitFile(f){
  splitFile=f;
  document.getElementById('split-file-list').innerHTML=`<div class="file-item"><span class="name">${f.name}</span><span class="size">${fmtSize(f.size)}</span><button onclick="clearSplit()">‚úï</button></div>`;
  document.getElementById('split-options').style.display='block';document.getElementById('split-btn').disabled=false;
}
function clearSplit(){splitFile=null;document.getElementById('split-file-list').innerHTML='';document.getElementById('split-options').style.display='none';document.getElementById('split-btn').disabled=true;document.getElementById('split-status').style.display='none';setProgress('split-fill','split-progress',null);}
function updateSplitUI(){const m=document.querySelector('input[name=split-mode]:checked').value;document.getElementById('split-range-ui').style.display=m==='range'?'block':'none';document.getElementById('split-custom-ui').style.display=m==='custom'?'block':'none';document.getElementById('split-all-info').style.display=m==='all'?'block':'none';}
async function splitPDF(){
  if(!splitFile)return;
  const btn=document.getElementById('split-btn');btn.disabled=true;
  showStatus('split-status','Memproses...','info');setProgress('split-fill','split-progress',5);
  try{
    const{PDFDocument}=PDFLib;const ab=await splitFile.arrayBuffer();const srcDoc=await PDFDocument.load(ab);
    const total=srcDoc.getPageCount();const mode=document.querySelector('input[name=split-mode]:checked').value;
    const baseName=splitFile.name.replace(/\.pdf$/i,'');const zip=new JSZip();
    if(mode==='all'){
      for(let i=0;i<total;i++){
        setProgress('split-fill','split-progress',10+Math.round((i/total)*80));
        const d=await PDFDocument.create();const[pg]=await d.copyPages(srcDoc,[i]);d.addPage(pg);
        zip.file(`${baseName}_page${i+1}.pdf`,await d.save());
      }
    }else if(mode==='range'){
      const raw=document.getElementById('split-ranges').value;
      if(!raw.trim()){showStatus('split-status','‚úó Isi range halaman dulu!','error');btn.disabled=false;return;}
      const ranges=raw.split(',').map(r=>r.trim()).filter(Boolean);
      for(let ri=0;ri<ranges.length;ri++){
        const pts=ranges[ri].split('-');const from=parseInt(pts[0])-1;const to=(pts[1]?parseInt(pts[1]):parseInt(pts[0]))-1;
        if(isNaN(from)||from<0||to>=total||from>to){showStatus('split-status',`‚úó Range "${ranges[ri]}" tidak valid (total ${total} hal)`,'error');btn.disabled=false;return;}
        const d=await PDFDocument.create();const pages=await d.copyPages(srcDoc,Array.from({length:to-from+1},(_,i)=>from+i));
        pages.forEach(p=>d.addPage(p));zip.file(`${baseName}_p${from+1}-${to+1}.pdf`,await d.save());
        setProgress('split-fill','split-progress',10+Math.round((ri/ranges.length)*85));
      }
    }else{
      const raw=document.getElementById('split-pages').value;
      if(!raw.trim()){showStatus('split-status','‚úó Isi nomor halaman dulu!','error');btn.disabled=false;return;}
      const pages=raw.split(',').map(p=>parseInt(p.trim())-1).filter(p=>!isNaN(p)&&p>=0&&p<total);
      if(!pages.length){showStatus('split-status','‚úó Tidak ada halaman valid','error');btn.disabled=false;return;}
      for(let pi=0;pi<pages.length;pi++){
        const d=await PDFDocument.create();const[pg]=await d.copyPages(srcDoc,[pages[pi]]);d.addPage(pg);
        zip.file(`${baseName}_page${pages[pi]+1}.pdf`,await d.save());
        setProgress('split-fill','split-progress',10+Math.round((pi/pages.length)*85));
      }
    }
    setProgress('split-fill','split-progress',95);
    downloadBlob(await zip.generateAsync({type:'blob'}),baseName+'_split.zip');
    setProgress('split-fill','split-progress',100);
    showStatus('split-status',`‚úì Berhasil! ‚Üí ${baseName}_split.zip`,'success');
  }catch(e){showStatus('split-status','‚úó Error: '+e.message,'error');setProgress('split-fill','split-progress',null);}
  btn.disabled=false;
}

// ====== PDF to DOCX ======
let p2dFile=null;
setupDrop('p2d-drop','p2d-input',files=>{const f=files.find(f=>f.name.match(/\.pdf$/i));if(f){p2dFile=f;document.getElementById('p2d-file-list').innerHTML=`<div class="file-item"><span class="name">${f.name}</span><span class="size">${fmtSize(f.size)}</span><button onclick="clearP2D()">‚úï</button></div>`;document.getElementById('p2d-btn').disabled=false;}});
function clearP2D(){p2dFile=null;document.getElementById('p2d-file-list').innerHTML='';document.getElementById('p2d-btn').disabled=true;document.getElementById('p2d-status').style.display='none';setProgress('p2d-fill','p2d-progress',null);}
async function convertPDF2DOCX(){
  if(!p2dFile)return;
  if(typeof pdfjsLib==='undefined'){showStatus('p2d-status','‚úó PDF.js belum dimuat. Cek koneksi internet.','error');return;}
  const btn=document.getElementById('p2d-btn');btn.disabled=true;
  showStatus('p2d-status','Membaca PDF...','info');setProgress('p2d-fill','p2d-progress',5);
  try{
    const ab=await p2dFile.arrayBuffer();const pdf=await pdfjsLib.getDocument({data:ab}).promise;
    const total=pdf.numPages;let fullText='';
    for(let i=1;i<=total;i++){
      setProgress('p2d-fill','p2d-progress',10+Math.round((i/total)*70));
      showStatus('p2d-status',`Mengekstrak halaman ${i} dari ${total}...`,'info');
      const page=await pdf.getPage(i);const content=await page.getTextContent();
      const lines={};
      content.items.forEach(item=>{if(!item.str)return;const y=Math.round(item.transform[5]);if(!lines[y])lines[y]=[];lines[y].push(item);});
      Object.keys(lines).map(Number).sort((a,b)=>b-a).forEach(y=>{
        const lineText=lines[y].sort((a,b)=>a.transform[4]-b.transform[4]).map(i=>i.str).join(' ').trim();
        if(lineText)fullText+=lineText+'\n';
      });
      fullText+='\n';
    }
    setProgress('p2d-fill','p2d-progress',85);showStatus('p2d-status','Membuat file DOCX...','info');
    const paras=fullText.split('\n').map(line=>{const e=line.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');return`<w:p><w:r><w:t xml:space="preserve">${e}</w:t></w:r></w:p>`;}).join('');
    const docXML=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:body>${paras}<w:sectPr><w:pgSz w:w="12240" w:h="15840"/></w:sectPr></w:body></w:document>`;
    const relsXML=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/></Relationships>`;
    const ctXML=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/></Types>`;
    const zip=new JSZip();zip.file('[Content_Types].xml',ctXML);zip.file('_rels/.rels',relsXML);zip.file('word/document.xml',docXML);zip.file('word/_rels/document.xml.rels',`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"></Relationships>`);
    setProgress('p2d-fill','p2d-progress',95);
    const outName=p2dFile.name.replace(/\.pdf$/i,'')+'.docx';
    downloadBlob(await zip.generateAsync({type:'blob',mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'}),outName);
    setProgress('p2d-fill','p2d-progress',100);showStatus('p2d-status',`‚úì Berhasil! ${total} halaman ‚Üí ${outName}`,'success');
  }catch(e){showStatus('p2d-status','‚úó Error: '+e.message,'error');setProgress('p2d-fill','p2d-progress',null);console.error(e);}
  btn.disabled=false;
}

// ====== DOCX to PDF ======
let d2pFile=null;
setupDrop('d2p-drop','d2p-input',files=>{const f=files.find(f=>f.name.match(/\.docx$/i));if(f){d2pFile=f;document.getElementById('d2p-file-list').innerHTML=`<div class="file-item"><span class="name">${f.name}</span><span class="size">${fmtSize(f.size)}</span><button onclick="clearD2P()">‚úï</button></div>`;document.getElementById('d2p-btn').disabled=false;}});
function clearD2P(){d2pFile=null;document.getElementById('d2p-file-list').innerHTML='';document.getElementById('d2p-btn').disabled=true;document.getElementById('d2p-status').style.display='none';setProgress('d2p-fill','d2p-progress',null);}
async function convertDOCX2PDF(){
  if(!d2pFile)return;
  if(typeof mammoth==='undefined'){showStatus('d2p-status','‚úó Mammoth.js belum dimuat.','error');return;}
  if(typeof window.jspdf==='undefined'){showStatus('d2p-status','‚úó jsPDF belum dimuat.','error');return;}
  const btn=document.getElementById('d2p-btn');btn.disabled=true;
  showStatus('d2p-status','Mengekstrak DOCX...','info');setProgress('d2p-fill','d2p-progress',10);
  try{
    const ab=await d2pFile.arrayBuffer();const result=await mammoth.extractRawText({arrayBuffer:ab});
    setProgress('d2p-fill','d2p-progress',40);showStatus('d2p-status','Membuat PDF...','info');
    const{jsPDF}=window.jspdf;const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const margin=20;const pageW=doc.internal.pageSize.getWidth();const pageH=doc.internal.pageSize.getHeight();
    const maxW=pageW-margin*2;const lineH=7;doc.setFontSize(11);doc.setFont('helvetica','normal');
    let y=margin;
    for(const para of result.value.split('\n')){
      if(!para.trim()){y+=lineH*0.5;continue;}
      for(const line of doc.splitTextToSize(para,maxW)){
        if(y+lineH>pageH-margin){doc.addPage();y=margin;}
        doc.text(line,margin,y);y+=lineH;
      }
    }
    setProgress('d2p-fill','d2p-progress',90);
    const outName=d2pFile.name.replace(/\.docx$/i,'')+'.pdf';doc.save(outName);
    setProgress('d2p-fill','d2p-progress',100);showStatus('d2p-status',`‚úì Berhasil! ‚Üí ${outName}`,'success');
  }catch(e){showStatus('d2p-status','‚úó Error: '+e.message,'error');setProgress('d2p-fill','d2p-progress',null);console.error(e);}
  btn.disabled=false;
}

// ====== PDF to PNG ======
let pdf2pngFile=null;
setupDrop('pdf2png-drop','pdf2png-input',files=>{const f=files.find(f=>f.name.match(/\.pdf$/i));if(f){pdf2pngFile=f;document.getElementById('pdf2png-file-list').innerHTML=`<div class="file-item"><span class="name">${f.name}</span><span class="size">${fmtSize(f.size)}</span><button onclick="clearPDF2PNG()">‚úï</button></div>`;document.getElementById('pdf2png-options').style.display='block';document.getElementById('pdf2png-btn').disabled=false;}});
document.getElementById('pdf2png-pages').addEventListener('change',function(){document.getElementById('pdf2png-custom-pages').style.display=this.value==='custom'?'block':'none';});
function clearPDF2PNG(){pdf2pngFile=null;document.getElementById('pdf2png-file-list').innerHTML='';document.getElementById('pdf2png-options').style.display='none';document.getElementById('pdf2png-btn').disabled=true;document.getElementById('pdf2png-status').style.display='none';setProgress('pdf2png-fill','pdf2png-progress',null);}
async function convertPDF2PNG(){
  if(!pdf2pngFile)return;
  if(typeof pdfjsLib==='undefined'){showStatus('pdf2png-status','‚úó PDF.js belum dimuat.','error');return;}
  const btn=document.getElementById('pdf2png-btn');btn.disabled=true;
  const scale=parseFloat(document.getElementById('pdf2png-scale').value)||2;
  const pageMode=document.getElementById('pdf2png-pages').value;
  showStatus('pdf2png-status','Membaca PDF...','info');setProgress('pdf2png-fill','pdf2png-progress',5);
  try{
    const ab=await pdf2pngFile.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:ab}).promise;
    const total=pdf.numPages;
    let pageNums=[];
    if(pageMode==='all'){
      pageNums=Array.from({length:total},(_,i)=>i+1);
    }else{
      const raw=document.getElementById('pdf2png-page-list').value;
      pageNums=raw.split(',').map(p=>parseInt(p.trim())).filter(p=>!isNaN(p)&&p>=1&&p<=total);
      if(!pageNums.length){showStatus('pdf2png-status','‚úó Nomor halaman tidak valid','error');btn.disabled=false;return;}
    }
    const zip=new JSZip();const baseName=pdf2pngFile.name.replace(/\.pdf$/i,'');
    for(let i=0;i<pageNums.length;i++){
      const pgNum=pageNums[i];
      setProgress('pdf2png-fill','pdf2png-progress',10+Math.round((i/pageNums.length)*82));
      showStatus('pdf2png-status',`Render halaman ${pgNum} dari ${pageNums.length}...`,'info');
      const page=await pdf.getPage(pgNum);
      const vp=page.getViewport({scale});
      const canvas=document.createElement('canvas');canvas.width=vp.width;canvas.height=vp.height;
      const ctx=canvas.getContext('2d');
      await page.render({canvasContext:ctx,viewport:vp}).promise;
      const blob=await new Promise(res=>canvas.toBlob(res,'image/png'));
      const arr=await blob.arrayBuffer();
      zip.file(`${baseName}_page${String(pgNum).padStart(3,'0')}.png`,arr);
    }
    setProgress('pdf2png-fill','pdf2png-progress',95);
    if(pageNums.length===1){
      // single file direct download
      const singleBlob=await zip.file(Object.keys(zip.files)[0]).async('blob');
      downloadBlob(new Blob([singleBlob],{type:'image/png'}),`${baseName}_page${pageNums[0]}.png`);
    }else{
      downloadBlob(await zip.generateAsync({type:'blob'}),baseName+'_pages.zip');
    }
    setProgress('pdf2png-fill','pdf2png-progress',100);
    showStatus('pdf2png-status',`‚úì ${pageNums.length} halaman dirender sebagai PNG`,'success');
  }catch(e){showStatus('pdf2png-status','‚úó Error: '+e.message,'error');setProgress('pdf2png-fill','pdf2png-progress',null);console.error(e);}
  btn.disabled=false;
}

// ====== IMG to PDF ======
let img2pdfFiles=[];
setupDrop('img2pdf-drop','img2pdf-input',files=>{
  const imgs=files.filter(f=>f.type.match(/image\/(jpeg|png)/));
  img2pdfFiles.push(...imgs);renderImg2PDFPreview();
});
function renderImg2PDFPreview(){
  const grid=document.getElementById('img2pdf-preview');
  const opts=document.getElementById('img2pdf-options');
  if(!img2pdfFiles.length){grid.innerHTML='';opts.style.display='none';document.getElementById('img2pdf-btn').disabled=true;return;}
  opts.style.display='block';document.getElementById('img2pdf-btn').disabled=false;
  grid.innerHTML=img2pdfFiles.map((f,i)=>{
    const url=URL.createObjectURL(f);
    return`<div class="img-thumb"><img src="${url}" loading="lazy"><span class="thumb-name">${f.name}</span><button class="thumb-del" onclick="img2pdfRemove(${i})">‚úï</button></div>`;
  }).join('');
}
function img2pdfRemove(i){img2pdfFiles.splice(i,1);renderImg2PDFPreview();}
function clearImg2PDF(){img2pdfFiles=[];renderImg2PDFPreview();document.getElementById('img2pdf-status').style.display='none';setProgress('img2pdf-fill','img2pdf-progress',null);}
async function convertImg2PDF(){
  if(!img2pdfFiles.length)return;
  const btn=document.getElementById('img2pdf-btn');btn.disabled=true;
  const pageSize=document.getElementById('img2pdf-pagesize').value;
  const margin=parseInt(document.getElementById('img2pdf-margin').value)||0;
  showStatus('img2pdf-status','Membuat PDF...','info');setProgress('img2pdf-fill','img2pdf-progress',5);
  try{
    const{PDFDocument,rgb}=PDFLib;const pdfDoc=await PDFDocument.create();
    for(let i=0;i<img2pdfFiles.length;i++){
      setProgress('img2pdf-fill','img2pdf-progress',10+Math.round((i/img2pdfFiles.length)*82));
      const file=img2pdfFiles[i];const ab=await file.arrayBuffer();
      let imgEmbed;
      if(file.type==='image/png'||file.name.match(/\.png$/i)){
        imgEmbed=await pdfDoc.embedPng(ab);
      }else{
        imgEmbed=await pdfDoc.embedJpg(ab);
      }
      const{width:iw,height:ih}=imgEmbed;
      let pw,ph;
      if(pageSize==='fit'){pw=iw+margin*2;ph=ih+margin*2;}
      else if(pageSize==='a4'){pw=595;ph=842;}
      else if(pageSize==='a4l'){pw=842;ph=595;}
      else{pw=612;ph=792;}// letter
      const page=pdfDoc.addPage([pw,ph]);
      let dw,dh,dx,dy;
      if(pageSize==='fit'){dw=iw;dh=ih;dx=margin;dy=margin;}
      else{
        const maxW=pw-margin*2;const maxH=ph-margin*2;
        const ratio=Math.min(maxW/iw,maxH/ih);
        dw=iw*ratio;dh=ih*ratio;dx=(pw-dw)/2;dy=(ph-dh)/2;
      }
      page.drawImage(imgEmbed,{x:dx,y:dy,width:dw,height:dh});
    }
    setProgress('img2pdf-fill','img2pdf-progress',95);
    const bytes=await pdfDoc.save();
    downloadBlob(new Blob([bytes],{type:'application/pdf'}),'images.pdf');
    setProgress('img2pdf-fill','img2pdf-progress',100);
    showStatus('img2pdf-status',`‚úì ${img2pdfFiles.length} gambar ‚Üí images.pdf`,'success');
  }catch(e){showStatus('img2pdf-status','‚úó Error: '+e.message,'error');setProgress('img2pdf-fill','img2pdf-progress',null);console.error(e);}
  btn.disabled=false;
}

// ====== JPG to PNG ======
let jpg2pngFiles=[];
setupDrop('jpg2png-drop','jpg2png-input',files=>{
  const imgs=files.filter(f=>f.type==='image/jpeg'||f.name.match(/\.jpe?g$/i));
  jpg2pngFiles.push(...imgs);renderJPG2PNGPreview();
});
function renderJPG2PNGPreview(){
  const grid=document.getElementById('jpg2png-preview');
  if(!jpg2pngFiles.length){grid.innerHTML='';document.getElementById('jpg2png-btn').disabled=true;return;}
  document.getElementById('jpg2png-btn').disabled=false;
  grid.innerHTML=jpg2pngFiles.map((f,i)=>{
    const url=URL.createObjectURL(f);
    return`<div class="img-thumb"><img src="${url}" loading="lazy"><span class="thumb-name">${f.name}</span><button class="thumb-del" onclick="jpg2pngRemove(${i})">‚úï</button></div>`;
  }).join('');
}
function jpg2pngRemove(i){jpg2pngFiles.splice(i,1);renderJPG2PNGPreview();}
function clearJPG2PNG(){jpg2pngFiles=[];renderJPG2PNGPreview();document.getElementById('jpg2png-status').style.display='none';setProgress('jpg2png-fill','jpg2png-progress',null);}
async function convertJPG2PNG(){
  if(!jpg2pngFiles.length)return;
  const btn=document.getElementById('jpg2png-btn');btn.disabled=true;
  showStatus('jpg2png-status','Mengkonversi...','info');setProgress('jpg2png-fill','jpg2png-progress',5);
  try{
    if(jpg2pngFiles.length===1){
      setProgress('jpg2png-fill','jpg2png-progress',40);
      const img=await loadImage(jpg2pngFiles[0]);
      const canvas=document.createElement('canvas');canvas.width=img.naturalWidth;canvas.height=img.naturalHeight;
      canvas.getContext('2d').drawImage(img,0,0);
      canvas.toBlob(blob=>{
        const outName=jpg2pngFiles[0].name.replace(/\.jpe?g$/i,'')+'.png';
        downloadBlob(blob,outName);
        setProgress('jpg2png-fill','jpg2png-progress',100);
        showStatus('jpg2png-status',`‚úì Berhasil ‚Üí ${outName}`,'success');
        btn.disabled=false;
      },'image/png');
      return;
    }
    // batch ‚Üí ZIP
    const zip=new JSZip();
    for(let i=0;i<jpg2pngFiles.length;i++){
      setProgress('jpg2png-fill','jpg2png-progress',10+Math.round((i/jpg2pngFiles.length)*82));
      showStatus('jpg2png-status',`Konversi ${i+1}/${jpg2pngFiles.length}...`,'info');
      const img=await loadImage(jpg2pngFiles[i]);
      const canvas=document.createElement('canvas');canvas.width=img.naturalWidth;canvas.height=img.naturalHeight;
      canvas.getContext('2d').drawImage(img,0,0);
      const blob=await new Promise(res=>canvas.toBlob(res,'image/png'));
      const arr=await blob.arrayBuffer();
      const outName=jpg2pngFiles[i].name.replace(/\.jpe?g$/i,'')+'.png';
      zip.file(outName,arr);
    }
    setProgress('jpg2png-fill','jpg2png-progress',95);
    downloadBlob(await zip.generateAsync({type:'blob'}),'converted_png.zip');
    setProgress('jpg2png-fill','jpg2png-progress',100);
    showStatus('jpg2png-status',`‚úì ${jpg2pngFiles.length} file dikonversi ‚Üí ZIP`,'success');
  }catch(e){showStatus('jpg2png-status','‚úó Error: '+e.message,'error');setProgress('jpg2png-fill','jpg2png-progress',null);console.error(e);}
  btn.disabled=false;
}
</script>
</body>
</html>
